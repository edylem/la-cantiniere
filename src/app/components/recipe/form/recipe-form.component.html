<p-dialog
  [(visible)]="visible"
  (visibleChange)="visibleChange.emit($event)"
  [modal]="true"
  [style]="{ width: '90vw', 'max-width': '900px' }"
  [dismissableMask]="true"
  [draggable]="false"
  [resizable]="false"
  [header]="
    isReadOnly ? 'Voir la recette' : isEditMode ? 'Modifier la recette' : 'Nouvelle recette'
  "
>
  <!-- Mode lecture seule : affichage direct sans champs de formulaire -->
  <ng-container *ngIf="isReadOnly && recipe">
    <div class="recipe-view">
      <!-- Titre -->
      <h2 class="recipe-title">{{ recipe.title }}</h2>

      <!-- Image -->
      <img
        *ngIf="recipe.image"
        [src]="recipe.image"
        alt="Image de la recette"
        class="recipe-image"
      />

      <!-- Métadonnées -->
      <div class="recipe-meta">
        <span *ngIf="recipe.personnes" class="meta-item">
          <i class="pi pi-users"></i> {{ recipe.personnes }} pers.
        </span>
        <span *ngIf="recipe.prepTime" class="meta-item">
          <i class="pi pi-clock"></i> {{ recipe.prepTime }} min
        </span>
        <span *ngIf="recipe.cost" class="meta-item">
          <i class="pi pi-euro"></i> {{ recipe.cost | number:'1.2-2' }}
        </span>
        <span *ngIf="recipe.season && recipe.season.length > 0" class="meta-item">
          <i class="pi pi-sun"></i> {{ recipe.season.join(', ') }}
        </span>
        <span *ngIf="recipe.category && recipe.category.length > 0" class="meta-item">
          <i class="pi pi-tag"></i> {{ recipe.category.join(', ') }}
        </span>
      </div>

      <!-- Ingrédients -->
      <div class="recipe-section">
        <h3>Ingrédients</h3>
        <ul class="ingredients-list">
          <li *ngFor="let ing of recipe.ingredients">
            <strong>{{ ing.name }}</strong>
            <span *ngIf="ing.quantity || ing.unit"> : {{ ing.quantity }} {{ ing.unit }}</span>
          </li>
        </ul>
      </div>

      <!-- Description -->
      <div class="recipe-section">
        <h3>Préparation</h3>
        <p class="recipe-description">{{ recipe.description }}</p>
      </div>

      <!-- Bouton Fermer -->
      <div class="flex justify-content-end mt-3">
        <p-button type="button" label="Fermer" [text]="true" (click)="onCancel()"></p-button>
      </div>
    </div>
  </ng-container>

  <!-- Mode édition : formulaire -->
  <form *ngIf="!isReadOnly" [formGroup]="recipeForm" (ngSubmit)="onSubmit()">
    <div class="grid gap-2">
      <!-- Titre -->
      <div class="col-12">
        <label for="title">Titre *</label>
        <input
          pInputText
          id="title"
          formControlName="title"
          class="w-full"
        />
      </div>

      <!-- Image -->
      <div class="col-12">
        <label>Image</label>
        <div class="flex gap-2 align-items-center">
          <p-button
            type="button"
            label="Sélectionner une image"
            icon="pi pi-image"
            [outlined]="true"
            (click)="fileInput.click()"
          ></p-button>
          <input
            #fileInput
            type="file"
            accept="image/*"
            (change)="onImageSelect($event)"
            style="display: none"
          />
        </div>
        <img
          *ngIf="recipeForm.get('image')?.value"
          [src]="recipeForm.get('image')?.value"
          alt="Aperçu de l'image"
          class="form-image-preview"
        />
      </div>

      <!-- Ingrédients -->
      <div class="col-12 ingredients-section">
        <p-fieldset legend="Ingrédients">
          <div formArrayName="ingredients">
            <div
              *ngFor="let ingredient of ingredients.controls; let i = index"
              [formGroupName]="i"
              class="ingredient-row"
            >
              <input
                pInputText
                formControlName="name"
                placeholder="Nom *"
                class="ingredient-name"
              />
              <p-inputnumber
                formControlName="quantity"
                [min]="0"
                placeholder="Qté"
                class="ingredient-qty"
              ></p-inputnumber>
              <input
                pInputText
                formControlName="unit"
                placeholder="Unité"
                class="ingredient-unit"
              />
              <p-button
                type="button"
                icon="pi pi-trash"
                severity="danger"
                [text]="true"
                (click)="removeIngredient(i)"
              ></p-button>
            </div>
          </div>

          <p-button
            type="button"
            label="Ajouter"
            icon="pi pi-plus"
            [outlined]="true"
            size="small"
            (click)="addIngredient()"
          ></p-button>
        </p-fieldset>
      </div>

      <!-- Description -->
      <div class="col-12">
        <label for="description">Description *</label>
        <textarea
          pTextarea
          id="description"
          formControlName="description"
          rows="4"
          class="w-full"
        ></textarea>
      </div>

      <!-- Nombre de personnes -->
      <div class="col-12 md:col-3">
        <label for="personnes">Nombre de personnes</label>
        <p-inputnumber
          id="personnes"
          formControlName="personnes"
          [min]="1"
          class="w-full"
        ></p-inputnumber>
      </div>

      <!-- Saison -->
      <div class="col-12 md:col-3">
        <label for="season">Saison</label>
        <p-multiSelect
          id="season"
          formControlName="season"
          [options]="seasons"
          optionLabel="label"
          optionValue="value"
          placeholder="Choisir les saisons"
          class="w-full"
        ></p-multiSelect>
      </div>

      <!-- Catégorie -->
      <div class="col-12 md:col-6">
        <label for="category">Catégorie</label>
        <p-multiSelect
          id="category"
          formControlName="category"
          [options]="categories"
          optionLabel="label"
          optionValue="value"
          placeholder="Choisir les catégories"
          class="w-full"
        ></p-multiSelect>
      </div>

      <!-- Temps de préparation -->
      <div class="col-12 md:col-3">
        <label for="prepTime">Temps (min)</label>
        <p-inputnumber
          id="prepTime"
          formControlName="prepTime"
          [min]="0"
          suffix=" min"
          class="w-full"
        ></p-inputnumber>
      </div>

      <!-- Coût -->
      <div class="col-12 md:col-3">
        <label for="cost">Coût (€)</label>
        <p-inputnumber
          id="cost"
          formControlName="cost"
          [min]="0"
          [minFractionDigits]="2"
          [maxFractionDigits]="2"
          prefix="€"
          class="w-full"
        ></p-inputnumber>
      </div>

      <!-- Actions -->
      <div class="col-12 flex gap-2 justify-content-end">
        <p-button type="button" label="Annuler" [text]="true" (click)="onCancel()"></p-button>
        <p-button
          type="submit"
          [label]="isEditMode ? 'Enregistrer' : 'Créer'"
          [disabled]="!recipeForm.valid"
        ></p-button>
      </div>
    </div>
  </form>
</p-dialog>
